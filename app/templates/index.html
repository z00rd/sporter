<!DOCTYPE html>
<html>
<head>
    <title>Sporter - GPX Analysis</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-main">
                <h1>üèÉ‚Äç‚ôÇÔ∏è Sporter</h1>
                <p>GPX Training Analysis Platform</p>
                <div class="repo-link">
                    <a href="https://github.com/z00rd/sporter" target="_blank" rel="noopener noreferrer">
                        üìÇ GitHub Repository
                    </a>
                </div>
            </div>
            <div class="header-controls">
                <div class="user-info">
                    <label for="user-select">Current User:</label>
                    <select id="user-select" class="user-select">
                        <option value="">Loading users...</option>
                    </select>
                </div>
                <button id="settings-button" class="btn btn-secondary">‚öôÔ∏è Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <div id="navigation">
        <!-- Navigation component will be rendered here -->
    </div>
    
    <!-- Page Container -->
    <div id="page-router">
        <!-- Individual pages will be rendered here by the page router -->
    </div>

    <!-- Load modular JavaScript components in dependency order -->
    <script src="/static/js/events.js"></script>
    <script src="/static/js/config.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/component.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/hrChart.js"></script>
    <script src="/static/js/userSettings.js"></script>
    <script src="/static/js/fileUpload.js"></script>
    <script src="/static/js/activityFeed.js"></script>
    <script src="/static/js/activityDetail.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/pageRouter.js"></script>
    <script src="/static/js/activitiesPage.js"></script>
    <script src="/static/js/analyticsPage.js"></script>
    <script src="/static/js/usersPage.js"></script>
    
    <script>
        // Initialize application with new navigation system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            // Check authentication first
            if (!authManager.isAuthenticated) {
                console.log('User not authenticated, showing login screen');
                authManager.showLoginScreen();
                return;
            }
            
            if (!authManager.isApproved) {
                console.log('User not approved, showing pending screen');
                authManager.showPendingApprovalMessage();
                return;
            }
            
            console.log('User authenticated and approved, initializing app...');
            
            // Declare variables at function scope
            let navigation, pageRouter;
            
            try {
                // Create navigation and page router
                console.log('Creating navigation and page router...');
                const navEl = document.getElementById('navigation');
                const routerEl = document.getElementById('page-router');
                console.log('Navigation element:', navEl);
                console.log('Page router element:', routerEl);
                
                if (navEl) {
                    console.log('Navigation element HTML:', navEl.innerHTML);
                } else {
                    console.error('Navigation element NOT FOUND!');
                }
                
                if (routerEl) {
                    console.log('Router element found');
                } else {
                    console.error('Router element NOT FOUND!');
                }
                
                navigation = new Navigation();
                console.log('Navigation created:', navigation);
                pageRouter = new PageRouter();
                console.log('PageRouter created:', pageRouter);
                
                // Create page instances
                console.log('Creating page instances...');
                activitiesPage = new ActivitiesPage();
                analyticsPage = new AnalyticsPage();
                usersPage = new UsersPage();
                
                // Create shared components
                console.log('Creating shared components...');
                userSettings = new UserSettings();
                
                // Register pages with the router
                console.log('Registering pages with router...');
                pageRouter.registerPage('activities', activitiesPage);
                console.log('Registered activities page');
                pageRouter.registerPage('analytics', analyticsPage);
                console.log('Registered analytics page');
                pageRouter.registerPage('users', usersPage);
                console.log('Registered users page');
                
                // For now, register settings page as analytics until we create a proper settings page
                pageRouter.registerPage('settings', analyticsPage);
                console.log('Registered settings page (using analytics placeholder)');
                
                // Initialize navigation and router
                console.log('Initializing navigation and router...');
                navigation.init();
                pageRouter.init();
                
                // Pages are already initialized by their constructors
                console.log('Pages created and initialized');
                
                // Clear any existing hash and show initial page
                console.log('Clearing hash and showing initial page...');
                window.location.hash = '';
                pageRouter.showInitialPage();
                
                // Navigation system is now working!
                
                console.log('All components initialized successfully');
                
                // Make global references available (for debugging/testing)
                window.navigation = navigation;
                window.pageRouter = pageRouter;
                window.activitiesPage = activitiesPage;
                window.analyticsPage = analyticsPage;
                window.usersPage = usersPage;
                window.userSettings = userSettings;
                
            } catch (error) {
                console.error('Error during initialization:', error);
            }
            
            // Setup settings button
            const settingsButton = document.getElementById('settings-button');
            if (settingsButton) {
                settingsButton.addEventListener('click', () => {
                    eventBus.emit(Events.SHOW_USER_SETTINGS);
                });
            }
            
            // Setup user selection dropdown
            const userSelect = document.getElementById('user-select');
            if (userSelect) {
                loadUsersDropdown();
                
                userSelect.addEventListener('change', async (e) => {
                    const userId = e.target.value;
                    if (userId) {
                        try {
                            // Save selected user to localStorage
                            localStorage.setItem('sporter_selected_user_id', userId);
                            
                            const user = await api.getUser(userId);
                            eventBus.emit(Events.USER_PROFILE_UPDATED, { user });
                        } catch (error) {
                            console.error('Failed to load user:', error);
                        }
                    }
                });
            }
            
            // Update user display when profile changes
            eventBus.on(Events.USER_PROFILE_LOADED, (data) => {
                updateUserSelect(data.user);
            });
            
            eventBus.on(Events.USER_PROFILE_UPDATED, (data) => {
                updateUserSelect(data.user);
            });
            
            async function loadUsersDropdown() {
                try {
                    const users = await api.getUsers();
                    const defaultUser = await api.getDefaultUser();
                    
                    // Check for saved user preference
                    const savedUserId = localStorage.getItem('sporter_selected_user_id');
                    let selectedUser = defaultUser;
                    
                    if (savedUserId) {
                        // Find the saved user in the users list
                        const savedUser = users.find(u => u.id.toString() === savedUserId);
                        if (savedUser) {
                            selectedUser = savedUser;
                        }
                    }
                    
                    userSelect.innerHTML = users.map(user => 
                        `<option value="${user.id}" ${selectedUser.id === user.id ? 'selected' : ''}>
                            ${user.name}${user.email ? ` (${user.email})` : ''}
                        </option>`
                    ).join('');
                    
                    eventBus.emit(Events.USER_PROFILE_LOADED, { user: selectedUser });
                } catch (error) {
                    console.error('Failed to load users:', error);
                    userSelect.innerHTML = '<option value="">Error loading users</option>';
                }
            }
            
            function updateUserSelect(user) {
                if (user && userSelect) {
                    userSelect.value = user.id;
                    // Save to localStorage when updated programmatically
                    localStorage.setItem('sporter_selected_user_id', user.id.toString());
                }
            }
            
            // Initial page is now handled by pageRouter.showInitialPage() above
        });
    </script>
</body>
</html>