# üîÑ Alembic Mini-Manual - Database Changes

## TL;DR Quick Workflow

```bash
# 1. Zmie≈Ñ model w app/models/*.py
# 2. Wygeneruj migration
./deployment/generate_migration.sh "describe your change"
# 3. Sprawd≈∫ wygenerowanƒÖ migration w alembic/versions/
# 4. Zastosuj do bazy
docker-compose --profile migration up migrate
```

## Szczeg√≥≈Çowy proces

### 1. **Dodanie kolumny do Activity**

**Edytujesz:** `app/models/activity.py`
```python
class Activity(Base):
    # ... existing columns ...
    
    # NEW COLUMN:
    difficulty_level = Column(String(20))  # easy, moderate, hard
    weather_conditions = Column(Text)      # free text description
    training_type = Column(String(50))     # interval, endurance, recovery
```

### 2. **Generowanie migration**

**Komenda:**
```bash
./deployment/generate_migration.sh "Add difficulty and weather fields to activity"
```

**Co siƒô dzieje:**
- Buduje Docker container z kodem
- Uruchamia `alembic revision --autogenerate`
- Por√≥wnuje obecne modele SQLAlchemy z aktualnym stanem bazy
- Tworzy plik migration w `alembic/versions/`

**Example output:**
```
=== Generating Alembic Migration ===
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.autogenerate.compare] Detected added column 'activities.difficulty_level'
INFO  [alembic.autogenerate.compare] Detected added column 'activities.weather_conditions'
INFO  [alembic.autogenerate.compare] Detected added column 'activities.training_type'
  Generating /app/alembic/versions/abc123def456_add_difficulty_and_weather_fields_to_activity.py ... done
‚úÖ Migration generated!
```

### 3. **Sprawdzenie wygenerowanej migration**

**File:** `alembic/versions/abc123def456_add_difficulty_and_weather_fields_to_activity.py`

```python
"""Add difficulty and weather fields to activity

Revision ID: abc123def456
Revises: a4f60831956b
Create Date: 2025-08-28 15:30:22.123456

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision: str = 'abc123def456'
down_revision: Union[str, None] = 'a4f60831956b'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('activities', sa.Column('difficulty_level', sa.String(length=20), nullable=True))
    op.add_column('activities', sa.Column('weather_conditions', sa.Text(), nullable=True))
    op.add_column('activities', sa.Column('training_type', sa.String(length=50), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('activities', 'training_type')
    op.drop_column('activities', 'weather_conditions')
    op.drop_column('activities', 'difficulty_level')
    # ### end Alembic commands ###
```

**‚ö†Ô∏è Sprawd≈∫:**
- Czy kolumny sƒÖ nullable=True (dla istniejƒÖcych rekord√≥w)
- Czy nie ma duplicate indexes lub conflicting constraints
- Czy downgrade() wyglƒÖda sensownie

### 4. **Aplikowanie migration**

**Komenda:**
```bash
docker-compose --profile migration up migrate
```

**Output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade a4f60831956b -> abc123def456, Add difficulty and weather fields to activity
‚úÖ Migration completed successfully
```

### 5. **Weryfikacja**

```bash
# Sprawd≈∫ struktur tabeli
docker-compose exec postgres psql -U dev -d sporter -c "\d activities"

# Sprawd≈∫ wersjƒô migration
docker-compose exec postgres psql -U dev -d sporter -c "SELECT version_num FROM alembic_version;"
```

## üõ†Ô∏è Alembic Commands Reference

### Podstawowe operacje

```bash
# Generuj nowƒÖ migration (autogenerate)
./deployment/generate_migration.sh "description of change"

# Zastosuj wszystkie pending migrations
docker-compose --profile migration up migrate

# Zobacz current migration version
docker-compose exec postgres psql -U dev -d sporter -c "SELECT version_num FROM alembic_version;"

# Zobacz historiƒô migrations
docker-compose --profile migration run --rm migrate alembic history
```

### Zaawansowane (manual migrations)

```bash
# Stw√≥rz pustƒÖ migration (manual SQL)
docker-compose --profile migration run --rm migrate alembic revision -m "manual change description"

# Upgrade do konkretnej wersji
docker-compose --profile migration run --rm migrate alembic upgrade abc123def456

# Downgrade o jeden krok
docker-compose --profile migration run --rm migrate alembic downgrade -1

# Zobacz pending changes (co zostanie zmienione)
docker-compose --profile migration run --rm migrate alembic show abc123def456
```

## üö® Common Issues & Solutions

### 1. **"No changes detected"**
```bash
# Problem: Alembic nie widzi zmian w modelach
# Solution: Sprawd≈∫ czy import modelu jest w alembic/env.py:
```
```python
# In alembic/env.py should be:
from app.models import Activity, Trackpoint, AnalysisSegment, AnalyticsCache
```

### 2. **PostGIS system tables w migration**
```
# Problem: Alembic pr√≥buje usunƒÖƒá spatial_ref_sys
# Solution: Ju≈º rozwiƒÖzane w include_object() w alembic/env.py
```

### 3. **Duplicate indexes**
```
# Problem: Duplicate GIST indexes for geometry columns
# Solution: Manually remove duplicates from generated migration
```

### 4. **Connection errors**
```bash
# Problem: Can't connect to database during migration
# Solution: Make sure postgres is running:
docker-compose up -d postgres
# Wait for healthy status before running migration
```

## üìù Best Practices

### Model Changes
- **Always make columns nullable=True** for existing data
- **Add default values** for NOT NULL columns
- **Use proper data types** (String(50) not Text for short fields)

### Migration Review
- **Always review** generated migration before applying
- **Test downgrade** in development environment
- **Backup production** before major schema changes

### Naming Conventions
- **Descriptive migration messages**: "Add user preferences table"
- **Column naming**: snake_case, descriptive names
- **Index naming**: let SQLAlchemy auto-generate or use descriptive names

## üîÑ Example: Complete Change Workflow

**Scenario:** Add `calories_burned` to Activity table

```bash
# 1. Edit model
vim app/models/activity.py
# Add: calories_burned = Column(Integer)

# 2. Generate migration
./deployment/generate_migration.sh "Add calories_burned field to activity"

# 3. Review generated file
cat alembic/versions/*calories_burned*.py

# 4. Apply migration
docker-compose --profile migration up migrate

# 5. Verify in database
docker-compose exec postgres psql -U dev -d sporter -c "SELECT calories_burned FROM activities LIMIT 1;"

# 6. Test in code
python3 -c "
import sys; sys.path.append('.')
from app.models.activity import Activity
print('‚úÖ Model updated, calories_burned field available')
"

# 7. Commit changes
git add app/models/activity.py alembic/versions/
git commit -m "feat: add calories_burned field to Activity model"
git push
```

**Result:** Database schema updated, model synced, ready for use in code! ‚úÖ